<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>è­·ç…§æ‹ç…§è£åˆ‡</title>
<script>
(function(){
  const ua = navigator.userAgent || navigator.vendor || window.opera;
  const isLine = ua.includes("Line");
  const isFB = ua.includes("FB") || ua.includes("FBAN") || ua.includes("FBAV");
  const isIG = ua.includes("Instagram");

  if (isLine || isFB || isIG) {
    if (/iPhone|iPad|iPod/i.test(ua)) {
      window.location.href = "googlechrome://" + window.location.href.replace(/^https?:\/\//, '');
      setTimeout(() => {
        alert("âš ï¸ è«‹ç”¨ Safari é–‹å•Ÿæ­¤ç¶²å€ï¼Œæ‰èƒ½ä½¿ç”¨ç›¸æ©ŸåŠŸèƒ½");
      }, 500);
    } else if (/Android/i.test(ua)) {
      window.location.href = "intent://" + window.location.href.replace(/^https?:\/\//, '') +
        "#Intent;scheme=https;package=com.android.chrome;end";
      setTimeout(() => {
        alert("âš ï¸ è«‹ç”¨ Chrome é–‹å•Ÿæ­¤ç¶²å€ï¼Œæ‰èƒ½ä½¿ç”¨ç›¸æ©ŸåŠŸèƒ½");
      }, 500);
    }
  }
})();
</script>
<style>
html, body {
  margin: 0; padding: 0;
  width: 100%; height: 100%;
  background: black;
  overflow: hidden;
  font-family: sans-serif;
}
#camera-container {
  position: relative;
  width: 100%;
  height: 100%;
}
video, canvas {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  background: black;
}
#red-frame {
  position: absolute;
  border: 3px solid red;
  box-sizing: border-box;
  z-index: 10;
}
#red-line {
  position: absolute;
  height: 3px;
  background: red;
  z-index: 11;
}
#controls {
  position: absolute;
  bottom: 10px;
  width: 100%;
  text-align: center;
  z-index: 20;
}
button {
  padding: 10px 20px;
  margin: 10px;
  font-size: 16px;
}
#preview-container {
  display: none;
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  background: black;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  z-index: 30;
}
#preview-container img {
  max-width: 90%;
  max-height: 80%;
}
</style>
</head>
<body>
  <div id="camera-container">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <div id="red-frame"></div>
    <div id="red-line"></div>
    <div id="controls">
      <button id="capture">ğŸ“¸ æ‹ç…§</button>
      <button id="debug-toggle">ğŸ” èª¿è©¦æ¨¡å¼</button>
    </div>
    <div id="debug-overlay" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:15;">
      <div id="calculated-crop" style="position:absolute; border:2px solid lime; background:rgba(0,255,0,0.2); box-sizing:border-box;"></div>
    </div>
    <div id="preview-container">
      <img id="preview-image" />
      <div>
        <button id="retake">é‡æ–°æ‹æ”</button>
        <button id="save">ç¹¼çºŒæ‹æ”</button>
      </div>
    </div>
  </div>
<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const captureBtn = document.getElementById("capture");
const debugBtn = document.getElementById("debug-toggle");
const previewContainer = document.getElementById("preview-container");
const previewImage = document.getElementById("preview-image");
const retakeBtn = document.getElementById("retake");
const saveBtn = document.getElementById("save");
const redFrame = document.getElementById("red-frame");
const redLine = document.getElementById("red-line");
const debugOverlay = document.getElementById("debug-overlay");
const calculatedCrop = document.getElementById("calculated-crop");

let debugMode = false;

function setRedFrame() {
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  const frameWidth = vw * 5 / 7;
  const frameHeight = vh * 3 / 5;
  const frameLeft = (vw - frameWidth) / 2;
  const frameTop = (vh - frameHeight) / 2;
  redFrame.style.width = frameWidth + "px";
  redFrame.style.height = frameHeight + "px";
  redFrame.style.left = frameLeft + "px";
  redFrame.style.top = frameTop + "px";
  redLine.style.left = frameLeft + "px";
  redLine.style.width = frameWidth + "px";
  redLine.style.top = (frameTop + frameHeight / 2 - 1.5) + "px";
}

async function initCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { 
        facingMode: "environment",
        width: { ideal: 1920 },
        height: { ideal: 1080 },
        frameRate: { ideal: 30 }
      }, 
      audio: false
    });
    video.srcObject = stream;
    console.log("ç›¸æ©Ÿåˆå§‹åŒ–æˆåŠŸ");
  } catch (err) {
    console.error("ç›¸æ©Ÿåˆå§‹åŒ–å¤±æ•—:", err);
    alert("ç„¡æ³•å­˜å–ç›¸æ©Ÿ: " + err);
  }
}

// å½±åƒå“è³ªå¢å¼·åŠŸèƒ½
function enhanceImage(ctx, width, height) {
  const imageData = ctx.getImageData(0, 0, width, height);
  const data = imageData.data;
  
  // 1. äº®åº¦å’Œå°æ¯”åº¦èª¿æ•´
  const brightness = 10; // å¢åŠ äº®åº¦
  const contrast = 1.15; // å¢åŠ å°æ¯”åº¦
  
  // 2. éŠ³åŒ–æ¿¾é¡æ ¸å¿ƒ
  const sharpenKernel = [
    0, -1, 0,
    -1, 5, -1,
    0, -1, 0
  ];
  
  // å‰µå»ºå‰¯æœ¬ç”¨æ–¼éŠ³åŒ–è™•ç†
  const originalData = new Uint8ClampedArray(data);
  
  for (let i = 0; i < data.length; i += 4) {
    // èª¿æ•´äº®åº¦å’Œå°æ¯”åº¦
    for (let j = 0; j < 3; j++) { // RGBé€šé“
      let pixel = data[i + j];
      // å°æ¯”åº¦èª¿æ•´
      pixel = ((pixel - 128) * contrast) + 128;
      // äº®åº¦èª¿æ•´
      pixel += brightness;
      // ç¢ºä¿å€¼åœ¨æœ‰æ•ˆç¯„åœå…§
      data[i + j] = Math.max(0, Math.min(255, pixel));
    }
  }
  
  // æ‡‰ç”¨éŠ³åŒ–æ¿¾é¡
  for (let y = 1; y < height - 1; y++) {
    for (let x = 1; x < width - 1; x++) {
      for (let c = 0; c < 3; c++) { // RGBé€šé“
        let sum = 0;
        for (let ky = -1; ky <= 1; ky++) {
          for (let kx = -1; kx <= 1; kx++) {
            const pixelIndex = ((y + ky) * width + (x + kx)) * 4 + c;
            const kernelIndex = (ky + 1) * 3 + (kx + 1);
            sum += originalData[pixelIndex] * sharpenKernel[kernelIndex];
          }
        }
        const currentIndex = (y * width + x) * 4 + c;
        data[currentIndex] = Math.max(0, Math.min(255, sum));
      }
    }
  }
  
  ctx.putImageData(imageData, 0, 0);
}

function updateDebugOverlay() {
  if (!debugMode) {
    debugOverlay.style.display = 'none';
    return;
  }
  
  debugOverlay.style.display = 'block';
  
  const vw = video.videoWidth;
  const vh = video.videoHeight;
  
  if (vw === 0 || vh === 0) return;
  
  const frameBox = redFrame.getBoundingClientRect();
  const redLineBox = redLine.getBoundingClientRect();
  const videoRect = video.getBoundingClientRect();
  const videoAspect = vw / vh;
  const displayAspect = videoRect.width / videoRect.height;
  
  let contentWidth, contentHeight, contentLeft, contentTop;
  
  if (videoAspect > displayAspect) {
    contentHeight = videoRect.height;
    contentWidth = contentHeight * videoAspect;
    contentTop = videoRect.top;
    contentLeft = videoRect.left + (videoRect.width - contentWidth) / 2;
  } else {
    contentWidth = videoRect.width;
    contentHeight = contentWidth / videoAspect;
    contentLeft = videoRect.left;
    contentTop = videoRect.top + (videoRect.height - contentHeight) / 2;
  }

  const scaleX = vw / contentWidth;
  const scaleY = vh / contentHeight;

  // åå‘è¨ˆç®—ï¼šå¾è¦–é »åƒç´ åº§æ¨™è½‰å›è¢å¹•åº§æ¨™
  const frameLeftInVideo = (frameBox.left - contentLeft) * scaleX;
  const frameTopInVideo = (frameBox.top - contentTop) * scaleY;
  const frameWidthInVideo = frameBox.width * scaleX;
  const frameHeightInVideo = frameBox.height * scaleY;
  const redLineTopInVideo = (redLineBox.top - contentTop) * scaleY;
  
  // è¨ˆç®—ä¸‹åŠéƒ¨å€åŸŸ
  const cropX = frameLeftInVideo;
  const cropY = redLineTopInVideo;
  const cropW = frameWidthInVideo;
  const cropH = frameTopInVideo + frameHeightInVideo - redLineTopInVideo;
  
  // è½‰æ›å›è¢å¹•åº§æ¨™é¡¯ç¤º
  const displayCropLeft = cropX / scaleX + contentLeft;
  const displayCropTop = cropY / scaleY + contentTop;
  const displayCropWidth = cropW / scaleX;
  const displayCropHeight = cropH / scaleY;
  
  calculatedCrop.style.left = displayCropLeft + 'px';
  calculatedCrop.style.top = displayCropTop + 'px';
  calculatedCrop.style.width = displayCropWidth + 'px';
  calculatedCrop.style.height = displayCropHeight + 'px';
}
  const vw = video.videoWidth;
  const vh = video.videoHeight;
  
  // ç­‰å¾…è¦–é »å®Œå…¨è¼‰å…¥
  if (vw === 0 || vh === 0) {
    console.log('è¦–é »å°šæœªè¼‰å…¥å®Œæˆ');
    return;
  }
  
  const frameBox = redFrame.getBoundingClientRect();
  const redLineBox = redLine.getBoundingClientRect();

  // é‡æ–°è¨ˆç®—è¦–é »å¯¦éš›é¡¯ç¤ºå€åŸŸ - ç›´æ¥åŸºæ–¼è¦–é »å…ƒç´ 
  const videoRect = video.getBoundingClientRect();
  const videoAspect = vw / vh;
  const displayAspect = videoRect.width / videoRect.height;
  
  // è¨ˆç®—è¦–é »å…§å®¹åœ¨é¡¯ç¤ºå€åŸŸä¸­çš„å¯¦éš›å°ºå¯¸å’Œä½ç½®
  let contentWidth, contentHeight, contentLeft, contentTop;
  
  if (videoAspect > displayAspect) {
    // è¦–é »è¼ƒå¯¬ï¼Œé«˜åº¦å¡«æ»¿ï¼Œå¯¬åº¦æœƒæœ‰è£åˆ‡æˆ–ç¸®æ”¾
    contentHeight = videoRect.height;
    contentWidth = contentHeight * videoAspect;
    contentTop = videoRect.top;
    contentLeft = videoRect.left + (videoRect.width - contentWidth) / 2;
  } else {
    // è¦–é »è¼ƒé«˜ï¼Œå¯¬åº¦å¡«æ»¿ï¼Œé«˜åº¦æœƒæœ‰è£åˆ‡æˆ–ç¸®æ”¾  
    contentWidth = videoRect.width;
    contentHeight = contentWidth / videoAspect;
    contentLeft = videoRect.left;
    contentTop = videoRect.top + (videoRect.height - contentHeight) / 2;
  }

  // è¨ˆç®—è½‰æ›æ¯”ä¾‹ï¼šå¾é¡¯ç¤ºåƒç´ åˆ°è¦–é »åƒç´ 
  const scaleX = vw / contentWidth;
  const scaleY = vh / contentHeight;

  // è½‰æ›ç´…æ¡†åº§æ¨™åˆ°è¦–é »åƒç´ åº§æ¨™
  const frameLeftInVideo = (frameBox.left - contentLeft) * scaleX;
  const frameTopInVideo = (frameBox.top - contentTop) * scaleY;
  const frameWidthInVideo = frameBox.width * scaleX;
  const frameHeightInVideo = frameBox.height * scaleY;
  
  // è½‰æ›ç´…ç·šåº§æ¨™åˆ°è¦–é »åƒç´ åº§æ¨™
  const redLineTopInVideo = (redLineBox.top - contentTop) * scaleY;
  
  // ç²¾ç¢ºè¨ˆç®—ä¸‹åŠéƒ¨è£åˆ‡å€åŸŸ
  const cropX = frameLeftInVideo;
  const cropY = redLineTopInVideo;
  const cropW = frameWidthInVideo;
  const cropH = frameTopInVideo + frameHeightInVideo - redLineTopInVideo;

  // é‚Šç•Œæª¢æŸ¥ï¼Œç¢ºä¿ä¸è¶…å‡ºè¦–é »ç¯„åœ
  const finalCropX = Math.max(0, Math.min(vw, cropX));
  const finalCropY = Math.max(0, Math.min(vh, cropY));
  const finalCropW = Math.min(vw - finalCropX, Math.max(0, cropW));
  const finalCropH = Math.min(vh - finalCropY, Math.max(0, cropH));

  // è¨­å®šæ¨™æº–è­·ç…§è¼¸å‡ºå°ºå¯¸
  canvas.width = 1476;
  canvas.height = 1040;
  const ctx = canvas.getContext("2d");
  
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  
  // ç¹ªè£½è£åˆ‡å€åŸŸåˆ°ç•«å¸ƒ
  ctx.drawImage(video, finalCropX, finalCropY, finalCropW, finalCropH, 0, 0, canvas.width, canvas.height);
  
  // è©³ç´°èª¿è©¦ä¿¡æ¯
  console.log('ç²¾ç¢ºåº§æ¨™è¨ˆç®—:', {
    è¦–é »åŸå§‹å°ºå¯¸: { width: vw, height: vh, aspect: videoAspect.toFixed(3) },
    è¦–é »å…ƒç´ é¡¯ç¤º: { 
      left: videoRect.left.toFixed(2), 
      top: videoRect.top.toFixed(2), 
      width: videoRect.width.toFixed(2), 
      height: videoRect.height.toFixed(2),
      aspect: displayAspect.toFixed(3)
    },
    è¦–é »å…§å®¹å¯¦éš›å€åŸŸ: {
      left: contentLeft.toFixed(2),
      top: contentTop.toFixed(2), 
      width: contentWidth.toFixed(2),
      height: contentHeight.toFixed(2)
    },
    è½‰æ›æ¯”ä¾‹: { scaleX: scaleX.toFixed(4), scaleY: scaleY.toFixed(4) },
    ç´…æ¡†: {
      è¢å¹•ä½ç½®: `${frameBox.left.toFixed(1)}, ${frameBox.top.toFixed(1)}, ${frameBox.width.toFixed(1)}x${frameBox.height.toFixed(1)}`,
      è¦–é »åº§æ¨™: `${frameLeftInVideo.toFixed(1)}, ${frameTopInVideo.toFixed(1)}, ${frameWidthInVideo.toFixed(1)}x${frameHeightInVideo.toFixed(1)}`
    },
    ç´…ç·šè¦–é »åº§æ¨™: redLineTopInVideo.toFixed(1),
    åŸå§‹è£åˆ‡: `x:${cropX.toFixed(1)}, y:${cropY.toFixed(1)}, w:${cropW.toFixed(1)}, h:${cropH.toFixed(1)}`,
    æœ€çµ‚è£åˆ‡: `x:${finalCropX.toFixed(1)}, y:${finalCropY.toFixed(1)}, w:${finalCropW.toFixed(1)}, h:${finalCropH.toFixed(1)}`,
    è¼¸å‡º: `${canvas.width}x${canvas.height}`
  });
  
  enhanceImage(ctx, canvas.width, canvas.height);
  
  const dataURL = canvas.toDataURL("image/bmp");
  previewImage.src = dataURL;
  previewContainer.style.display = "flex";
  saveBtn.dataset.url = dataURL;
}

captureBtn.onclick = () => cropAndPreview();
debugBtn.onclick = () => {
  debugMode = !debugMode;
  debugBtn.textContent = debugMode ? 'ğŸ” é—œé–‰èª¿è©¦' : 'ğŸ” èª¿è©¦æ¨¡å¼';
  updateDebugOverlay();
};
retakeBtn.onclick = () => previewContainer.style.display = "none";
saveBtn.onclick = () => {
  const link = document.createElement("a");
  link.href = saveBtn.dataset.url;
  link.download = "passport.bmp";
  link.click();
  previewContainer.style.display = "none";
};

window.addEventListener("resize", () => {
  setRedFrame();
  updateDebugOverlay();
});

// ç›£è½è¦–é »è¼‰å…¥å®Œæˆ
video.addEventListener('loadedmetadata', updateDebugOverlay);

// ç¢ºä¿ç›¸æ©Ÿåˆå§‹åŒ–
console.log("é–‹å§‹åˆå§‹åŒ–ç›¸æ©Ÿ...");
initCamera();
setRedFrame();

// åˆå§‹åŒ–èª¿è©¦æ¨¡å¼
setTimeout(() => {
  updateDebugOverlay();
}, 1000);
</script>
</body>
</html>