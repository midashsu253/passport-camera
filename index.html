<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>護照拍照裁切</title>
<script>
(function(){
  const ua = navigator.userAgent || navigator.vendor || window.opera;
  const isLine = ua.includes("Line");
  const isFB = ua.includes("FB") || ua.includes("FBAN") || ua.includes("FBAV");
  const isIG = ua.includes("Instagram");

  if (isLine || isFB || isIG) {
    if (/iPhone|iPad|iPod/i.test(ua)) {
      window.location.href = "googlechrome://" + window.location.href.replace(/^https?:\/\//, '');
      setTimeout(() => {
        alert("⚠️ 請用 Safari 開啟此網址，才能使用相機功能");
      }, 500);
    } else if (/Android/i.test(ua)) {
      window.location.href = "intent://" + window.location.href.replace(/^https?:\/\//, '') +
        "#Intent;scheme=https;package=com.android.chrome;end";
      setTimeout(() => {
        alert("⚠️ 請用 Chrome 開啟此網址，才能使用相機功能");
      }, 500);
    }
  }
})();
</script>
<style>
html, body {
  margin: 0; padding: 0;
  width: 100%; height: 100%;
  background: black;
  overflow: hidden;
  font-family: sans-serif;
}
#camera-container {
  position: relative;
  width: 100%;
  height: 100%;
}
video, canvas {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  background: black;
}
#red-frame {
  position: absolute;
  border: 3px solid red;
  box-sizing: border-box;
  z-index: 10;
}
#red-line {
  position: absolute;
  height: 3px;
  background: red;
  z-index: 11;
}
#controls {
  position: absolute;
  bottom: 10px;
  width: 100%;
  text-align: center;
  z-index: 20;
}
button {
  padding: 10px 20px;
  margin: 10px;
  font-size: 16px;
}
#preview-container {
  display: none;
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  background: black;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  z-index: 30;
}
#preview-container img {
  max-width: 90%;
  max-height: 80%;
}
</style>
</head>
<body>
  <div id="camera-container">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <div id="red-frame"></div>
    <div id="red-line"></div>
    <div id="controls">
      <button id="capture">📸 拍照</button>
    </div>
    <div id="preview-container">
      <img id="preview-image" />
      <div>
        <button id="retake">重新拍攝</button>
        <button id="save">繼續拍攝</button>
      </div>
    </div>
  </div>
<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const captureBtn = document.getElementById("capture");
const previewContainer = document.getElementById("preview-container");
const previewImage = document.getElementById("preview-image");
const retakeBtn = document.getElementById("retake");
const saveBtn = document.getElementById("save");

const redFrame = document.getElementById("red-frame");
const redLine = document.getElementById("red-line");

function setRedFrame() {
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  const frameWidth = vw * 5 / 7;
  const frameHeight = vh * 3 / 5;
  const frameLeft = (vw - frameWidth) / 2;
  const frameTop = (vh - frameHeight) / 2;
  redFrame.style.width = frameWidth + "px";
  redFrame.style.height = frameHeight + "px";
  redFrame.style.left = frameLeft + "px";
  redFrame.style.top = frameTop + "px";
  redLine.style.left = frameLeft + "px";
  redLine.style.width = frameWidth + "px";
  redLine.style.top = (frameTop + frameHeight / 2 - 1.5) + "px";
}

async function initCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { 
        facingMode: "environment",
        width: { ideal: 1920 },
        height: { ideal: 1080 },
        frameRate: { ideal: 30 }
      }, 
      audio: false
    });
    video.srcObject = stream;
  } catch (err) {
    alert("無法存取相機: " + err);
  }
}

// 影像品質增強功能
function enhanceImage(ctx, width, height) {
  const imageData = ctx.getImageData(0, 0, width, height);
  const data = imageData.data;
  
  // 1. 亮度和對比度調整
  const brightness = 10; // 增加亮度
  const contrast = 1.15; // 增加對比度
  
  // 2. 銳化濾鏡核心
  const sharpenKernel = [
    0, -1, 0,
    -1, 5, -1,
    0, -1, 0
  ];
  
  // 創建副本用於銳化處理
  const originalData = new Uint8ClampedArray(data);
  
  for (let i = 0; i < data.length; i += 4) {
    // 調整亮度和對比度
    for (let j = 0; j < 3; j++) { // RGB通道
      let pixel = data[i + j];
      // 對比度調整
      pixel = ((pixel - 128) * contrast) + 128;
      // 亮度調整
      pixel += brightness;
      // 確保值在有效範圍內
      data[i + j] = Math.max(0, Math.min(255, pixel));
    }
  }
  
  // 應用銳化濾鏡
  for (let y = 1; y < height - 1; y++) {
    for (let x = 1; x < width - 1; x++) {
      for (let c = 0; c < 3; c++) { // RGB通道
        let sum = 0;
        for (let ky = -1; ky <= 1; ky++) {
          for (let kx = -1; kx <= 1; kx++) {
            const pixelIndex = ((y + ky) * width + (x + kx)) * 4 + c;
            const kernelIndex = (ky + 1) * 3 + (kx + 1);
            sum += originalData[pixelIndex] * sharpenKernel[kernelIndex];
          }
        }
        const currentIndex = (y * width + x) * 4 + c;
        data[currentIndex] = Math.max(0, Math.min(255, sum));
      }
    }
  }
  
  ctx.putImageData(imageData, 0, 0);
}

// 去噪處理
function denoiseImage(ctx, width, height) {
  const imageData = ctx.getImageData(0, 0, width, height);
  const data = imageData.data;
  const output = new Uint8ClampedArray(data);
  
  // 簡單的中值濾波去噪
  for (let y = 1; y < height - 1; y++) {
    for (let x = 1; x < width - 1; x++) {
      for (let c = 0; c < 3; c++) {
        const neighbors = [];
        for (let dy = -1; dy <= 1; dy++) {
          for (let dx = -1; dx <= 1; dx++) {
            const index = ((y + dy) * width + (x + dx)) * 4 + c;
            neighbors.push(data[index]);
          }
        }
        neighbors.sort((a, b) => a - b);
        const currentIndex = (y * width + x) * 4 + c;
        output[currentIndex] = neighbors[4]; // 中位數
      }
    }
  }
  
  const newImageData = new ImageData(output, width, height);
  ctx.putImageData(newImageData, 0, 0);
}

function cropAndPreview() {
  const vw = video.videoWidth;
  const vh = video.videoHeight;
  const videoBox = video.getBoundingClientRect();
  const frameBox = redFrame.getBoundingClientRect();

  const videoAspect = vw / vh;
  const screenAspect = videoBox.width / videoBox.height;
  let offsetX = 0, offsetY = 0, displayW = videoBox.width, displayH = videoBox.height;

  if (videoAspect > screenAspect) {
    displayW = videoBox.height * videoAspect;
    offsetX = (videoBox.width - displayW) / 2;
  } else {
    displayH = videoBox.width / videoAspect;
    offsetY = (videoBox.height - displayH) / 2;
  }

  const scaleX = vw / displayW;
  const scaleY = vh / displayH;

  // 精確計算下半部紅框的裁切區域
  const frameLeftInVideo = (frameBox.left - videoBox.left - offsetX) * scaleX;
  const frameTopInVideo = (frameBox.top - videoBox.top - offsetY) * scaleY;
  const frameWidthInVideo = frameBox.width * scaleX;
  const frameHeightInVideo = frameBox.height * scaleY;
  
  // 下半部紅框的精確範圍
  const cropX = Math.max(0, frameLeftInVideo);
  const cropY = Math.max(0, frameTopInVideo + (frameHeightInVideo / 2));
  const cropW = Math.min(vw - cropX, frameWidthInVideo);
  const cropH = Math.min(vh - cropY, frameHeightInVideo / 2);

  // 設置 300 DPI 的護照規格輸出尺寸
  canvas.width = 1476;   // 300 DPI 護照寬度
  canvas.height = 1040;  // 300 DPI 護照高度
  const ctx = canvas.getContext("2d");
  
  // 設置高品質渲染
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  
  // 繪製影像並加上調試信息
  ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, canvas.width, canvas.height);
  
  // 調試信息 (可選擇是否顯示)
  console.log('裁切參數:', {
    cropX: cropX.toFixed(2),
    cropY: cropY.toFixed(2), 
    cropW: cropW.toFixed(2),
    cropH: cropH.toFixed(2),
    frameBox: {
      left: frameBox.left,
      top: frameBox.top,
      width: frameBox.width,
      height: frameBox.height
    },
    videoBox: {
      left: videoBox.left,
      top: videoBox.top,
      width: videoBox.width,
      height: videoBox.height
    },
    offset: { offsetX, offsetY }
  });
  
  // 應用影像品質增強
  enhanceImage(ctx, canvas.width, canvas.height);
  
  // 輕微去噪處理（只在必要時使用）
  // denoiseImage(ctx, canvas.width, canvas.height);

  // 保存為無損的 BMP 格式，避免 Line 傳輸時的二次壓縮失真
  const dataURL = canvas.toDataURL("image/bmp");
  previewImage.src = dataURL;
  previewContainer.style.display = "flex";
  saveBtn.dataset.url = dataURL;
}

captureBtn.onclick = () => cropAndPreview();
retakeBtn.onclick = () => previewContainer.style.display = "none";
saveBtn.onclick = () => {
  const link = document.createElement("a");
  link.href = saveBtn.dataset.url;
  link.download = "passport.bmp"; // BMP 格式避免壓縮失真
  link.click();
  previewContainer.style.display = "none";
};

window.addEventListener("resize", setRedFrame);
initCamera();
setRedFrame();
</script>
</body>
</html>